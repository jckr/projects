var values="Canada;5318190;5361310;5420900;5400800;5405080;5412870;5440980;5441560;5449740;5423480;5443860;5509850;5577900;5601900;5623450;5646110;5680690;5285310;5292670;5299190;5230590;5189580;5162380;5134360;5096860;5054160;5001030;5001290;4974440;4953610;4945020;4923760;4910340;4895500$USA;2880690;2693650;2701710;2654000;2692050;2699100;2728290;2744490;2760670;2755160;2769490;2814340;2908360;2959580;3021580;3065710;3143140;2752380;2513010;2452650;2340540;2274620;2204660;2163110;2116030;2093130;2048230;2015450;1950540;1922340;1906120;1902670;1886310;1890000$Mexico;232026;228568;225638;188823;188823;185203;185203;190432;190432;180297;163092;162778;162850;168059;168059;165209;165325;213070;188098;163923;116821;90325;89400.3;67733.1;73401.9;67759.5;70498.4;59118.8;59110.2;56868.7;56861.7;56861.7;56853;59770.1$Brazil;4902200;4730370;4566240;4514700;4466400;4362320;4325420;4226970;4156330;4126480;4089480;4140320;4226510;4313080;4440580;4528940;4600140;4595110;4355360;3960680;3699090;3486610;3333920;3206130;3187660;3034920;2935070;2861240;2790540;2723760;2659180;2656150;2570170;2535900$Turkey;66288.4;66266.6;66266.6;59194.1;59194.1;61502;61502;58776.2;61084.3;58455.6;52110.4;47391.2;43388.1;43304.9;38667.8;38597;38597;57001.6;50922.9;46274.1;34591.9;29941.2;26163.1;21846.2;17352.1;15045.7;11105.3;4667.08;6972.62;0;0;0;0;0$Korea;169748;157579;159946;157343;161105;160965;158598;153673;156035;153341;150884;155685;158138;160212;160212;157731;157731;159473;149773;144868;135059;132598;125439;122099;121472;119916;117334;111989;109431;96610.7;88047;60321.2;45457.3;23496.1$Japan;295394;293109;295692;294931;299246;300771;300771;307739;302395;305892;309603;313365;317425;317972;321052;323510;326712;245813;230004;206499;188151;169606;149405;133039;127941;112178;102600;83115.8;69168.3;50182.9;26942.1;5155.31;0;0$Oceania;442617;398288;411512;429098;416695;470133;364490;302170;256169;228885;219532;213127;213127;206179;206053;207054;207708;429699;379989;377951;349261;286259;316301;197330;184677;167732;144995;139723;134368;134368;122759;120323;114570;108220$C.Europe;548134;531727;543816;535908;559579;604490;583885;542680;504614;473884;451951;472252;497331;515819;534802;545472;555509;501298;454106;422309;380923;351895;328030;289583;238593;191386;152330;112238;79438.7;48285.6;18123.7;0;0;0$China;2644890;2503810;2296710;2218270;1628200;1437720;1192140;1001480;920526;855501;841763;1039900;1224150;1357060;1534660;1674860;1810000;2451960;2308670;2105170;1999100;1376020;1155060;916700;737623;638102;552890;522297;509310;356661;258580;207706;108537;67370.5$E.Africa;338680;323742;256554;238575;235675;238558;242258;246204;280850;231916;219455;195729;186669;198119;224527;254124;266199;175163;14744.6;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0$India;561231;537366;537366;531642;517412;506528;495679;491709;492792;481608;481647;459852;434518;430017;415609;414182;418819;329686;131505;420.715;0;0;0;0;0;0;0;0;0;0;0;0;0;0$Indonesia;1945650;1936620;1955810;1939040;1908640;1908520;1883210;1868510;1860560;1852120;1855180;1859200;1860260;1866900;1870880;1869680;1872610;1894280;1830500;1760360;1676670;1582480;1491260;1382620;1313780;1232630;1195970;1131920;1085550;1038640;1007360;977451;958120;937773$Rest C.Am.;415688;393937;382208;373029;345204;339817;333771;328453;326361;307280;281790;270811;265466;261191;253382;246260;237515;391449;363646;330135;300161;266975;244099;224674;201244;185521;164896;139957;119351;105089;86062.4;73085.5;61935.2;59406.2$Rest S.Am.;3499220;3535510;3433380;3470880;3427730;3426660;3354280;3196760;3067280;2995190;2950220;2909510;2874540;2883290;2921100;2935820;2967680;3416600;3353600;3199420;3114570;3015710;2922180;2816240;2695780;2581360;2484310;2429300;2368600;2311940;2287340;2250070;2218240;2206300$Russia;11747600;11745900;11797400;11809300;11794200;11888100;11738900;11532700;11333100;11340800;11372100;11591300;11771800;11920800;12042800;12204600;12373100;11471600;11323200;11209300;11100000;10963300;10875800;10778600;10660000;10541200;10499600;10453400;10406400;10369700;10363800;10336300;10328800;10333800$S.Africa;212861;171964;165925;165737;171723;179491;177088;178700;194238;149242;129304;98736.5;68959.8;29978.8;27332.3;33452.8;36511.3;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0$SE.Asia;1165880;1141880;1133380;1116690;1102700;1083450;1076850;1081260;1100540;1098070;1092150;1100090;1103190;1107030;1121790;1139720;1152940;1078590;980702;869210;802178;685750;578706;494172;445837;444518;413803;391369;366515;325629;325581;301918;299565;299312$Stan;51394.3;51391.8;51391.8;51388.6;49207.3;51397.3;53810;43798.3;40325.8;38169.3;60544.5;71792.6;80751;80738;80738;80726;88005.5;49369.9;47363.3;44984.2;42976.9;38832.7;36878.5;34586.6;26605.2;20578.8;17943.6;15980.7;16067.4;13624.7;11598.9;9219.79;7236.04;12087.8$Ukraine;255815;255742;277874;277529;279234;294380;274678;223770;170972;125208;80966.2;80940.8;77112;88904;105943;120829;130363;242750;227373;217867;209480;198256;192261;182578;148504;108767;76413.9;41202.2;33484;25999.8;16779.9;7444.13;0;0$W.Africa;2644700;2692660;2581020;2502120;2520340;2534710;2547730;2347270;2244540;2095430;1973700;1797040;1711300;1699460;1730240;1770240;1851660;2366670;2039130;1676720;1275500;865771;429482;144290;0;0;0;0;0;0;0;0;0;0$W.Europe;1577300;1588110;1614750;1625030;1666830;1722090;1736400;1766670;1789160;1762680;1734990;1725650;1727880;1744050;1753240;1760850;1766330;1482050;1421750;1370270;1323880;1262970;1205850;1149680;1109870;1062820;1002920;940227;882726;834984;797853;766130;726656;690560$";

data=values.split("$").map(function(line) {
	var lineS=line.split(";");
	var record={name:lineS[0],total:lineS.slice(1,18).map(parseFloat),primary:lineS.slice(18,35).map(parseFloat)};
	record.production=d3.range(17).map(function(i) {return record.total[i]-record.primary[i];});
	return record;})

data.forEach(function(d,i) {
	if(!i) {d.cumTotal=d3.range(17).map(return[0];});d.cumPrimary=d.cumTotal.slice();}
	else
	{
		d.cumTotal=data[i-1].cumTotal.map(function(v,j) {return v+d.total[j];});
		d.cumPrimary=data[i-1].cumPrimary.map(function(v,j) {return v+d.total[j];});
	}
});
svg=d3.select("#chart").append("svg:svg");

var years=16;
var maxA=42000000; // 42 million

var w=600,h=600;

var x=d3.scale.linear().domain([0,years]).range([0,w]);
var y=d3.scale.linear().domain([0,maxA]).range([h,0]);

var line=d3.svg.area().x(function(d,i) {return x(i);}).y(function(d) {return y(d);});


var lineP=function(d) {return line(d.cumTrimary);}
var lineT=function(d) {return line(d.cumTotal);}

var total=svg.selectAll(".total").data(data).enter().append("svg:path").attr("d",lineT).style("fill","blue").style("stroke","black").style("opacity",.2);
var primary=svg.selectAll(".primary").data(data).enter().append("svg:path").attr("d",lineP).style("fill","white").style("stroke","black").style("opacity",.2);



var stdFont="'Helvetica Neue', Arial, Helvetica, sans-serif"
var chevron=[{x:0.0167, y:0.0167},{x:0.4667, y:0.3833},{x:0.4667, y:0.6167},{x:0.0167, y:0.9833},{x:0.0167, y:0.75},{x:0.3333, y:0.5},{x:0.0167, y:0.25}]

String.prototype.visualLength = function(myClass)
{
	if(!d3.select("#ruler")[0][0]) {var ruler=d3.select("body").append("span").attr("id","ruler").style("visibility","hidden").style("white-space","nowrap");} else {var ruler=d3.select("#ruler");}
	ruler.classed(myClass,1);
	ruler.html(this);
	return ruler[0][0].offsetWidth;
}


String.prototype.visualFLength = function(font)
{
	if(!d3.select("#ruler")[0][0]) {var ruler=d3.select("body").append("span").attr("id","ruler").style("visibility","hidden").style("white-space","nowrap");} else {var ruler=d3.select("#ruler");}
	ruler.style("font",font);
	ruler.html(this);
	return ruler[0][0].offsetWidth;
}


function complete(attr) {
	var sizes=d3.range(5);
	var heights=[533,400,220,195,200];
	var widths=[800,600,330,260,250];
	var fontSizes=[[32,24,16,16],[24,24,12,12],[14,12,10,10],[12,12,9,9],[12,12,9,9]];
	var headerSizes=[87,65,40,40,35];
	var footerSizes=[80,65,50,50,50];
	
	var size;
	var myMin,myMax;
	
	var h=function(d) {return attr.hasOwnProperty(d);}
	
	if (h("data")){
		if (sizes.indexOf(parseFloat(attr["size"]))===-1){size=2}else{size=attr["size"];}
		
		if (!h("height")) {attr["height"]=heights[size];}
		if (!h("width"))  {attr["width"] =widths [size];}
		if (!h("fontTitle")) {attr["fontTitle"]="bold "+fontSizes[size][0]+"px "+stdFont;}
		if (!h("fontSubtitle")) {attr["fontSubtitle"]=fontSizes[size][1]+"px "+stdFont;}
		if (!h("fontLabel")) {attr["fontLabel"]=fontSizes[size][2]+"px "+stdFont;}
		if (!h("fontUnit")) {attr["fontUnit"]=fontSizes[size][3]+"px "+stdFont;}
		if (!h("ch")) {attr["ch"]=1.2*(fontSizes[size][0]+fontSizes[size][1]);}
		if (!h("cw")) {attr["cw"]=.5*attr["ch"];}
		if (!h("hTitle")) {attr["hTitle"]=attr["ch"]+5;}
		if (!h("lMargin")) {attr["lMargin"]=attr["cw"]+5;}

		if (!h("title")) {attr["title"]="";}
		if (!h("subtitle")) {attr["subtitle"]="";}
		
		if (!h("logo")) {attr["logo"]=false;}
		if (!h("blue")) {attr["blue"]=false;}
		
		if (h("stacked")) {myMin=d3.min(attr["data"],function(d) {return d3.sum(d.values);});myMin=d3.min([0,myMin]);
				 myMax=d3.max(attr["data"],function(d) {return d3.sum(d.values);});}
			else	{myMin=d3.min(attr["data"],function(d) {return d3.min(d.values);});myMin=d3.min([0,myMin]);
				 myMax=d3.max(attr["data"],function(d) {return d3.max(d.values);});}
		
		if (!h("min")) {attr["min"]=myMin;}
		if (!h("max")) {attr["max"]=myMax;}
		
		if (!h("digits")) {attr["digits"]=0;}
	
		if (!h("lAngle")) {attr["lAngle"]=0;}
			
		if (!h("header")) {attr["header"]=headerSizes[size];}
		if (!h("margin")) {attr["margin"]=headerSizes[size];}
		if (!h("axis")) {attr["axis"]=attr["max"].toFixed(attr["digits"]).visualLength(attr["fontLabel"])+5;}
		if (!h("footer")) {attr["footer"]=footerSizes[size];
				 if (attr["lAngle"]) {
				 	attr["footer"]+=d3.max(attr["data"],function(d) {return (12*Math.cos(attr["lAngle"])-d.category.visualLength(attr["fontLabel"])*Math.sin(attr["lAngle"]));})-12
				 }
				}
	}
	return attr;	
}


function stackedChart(attr)
{
// version 2.0
// this is the code for a horizontal, stacked bar chart.

	if (attr["data"]&&attr["div"]) { // that we really need. the rest, we can manage
		attr["stacked"]=true;
		attr=complete(attr);

		var data=attr["data"];
		var div=attr["div"];
		var height=attr["height"];
		var width=attr["width"];
		var min=attr["min"];
		var max=attr["max"];
		var axis=attr["axis"];
		var ticks=attr["ticks"];
		var lAngle=attr["lAngle"];

		var margin=attr["margin"];
		var axis=attr["axis"];
		var header=attr["header"];
		var footer=attr["footer"];

		var chartAreaWidth=width-margin-axis; 
		var chartAreaHeight=height-footer-header; 

		// end of temp variables



		var x=d3.scale.ordinal()
		  .domain(d3.range(data.length))
		  .rangeBands([0,chartAreaWidth],.1);
		var y,y2;
		y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
		y2=d3.scale.linear().domain([0,max-min]).range([0,chartAreaHeight]);
		d3.select(div).selectAll("svg").remove();
		var svg=d3.select(div).append("svg:svg");
		svg.attr("width",width).attr("height",height)
		svg.append("svg:rect").attr("width",width).attr("height",height).style("fill","white");
		var chart=svg.append("svg:g");
		var chartarea=svg.append("svg:g").attr("transform","translate("+axis+","+header+")").classed("chartarea",1);
		chartarea.append("svg:rect").attr("width",chartAreaWidth).attr("height",chartAreaHeight).style("fill","white");
		var columns=chartarea
			.selectAll(".column")
			.data(data)
			.enter()
			.append("svg:g")
			.attr("class","column");

		columns.attr("transform", function(d,i) {return "translate("+x(i)+",0)";})
		columns.selectAll("a").data(
				function(d) {
					return d.values.map(function(v,i) {return [d.category,parseFloat(v),d3.sum(d.values.slice(0,i)),((attr["sColor"]+i)%10)];})}
			).enter()
			.append("svg:a").attr("title",function(d) {return d[0]+": "+d[1];})
			.append("svg:rect")
				.attr("class",function(d) {return "stackedRect v"+d[3];})
				.attr("y",y(0))
				.attr("height",0)
				.attr("width",function() {return x.rangeBand();});
		columns.selectAll(".stackedRect").transition()
			.delay(100).duration(1000)
			.attr("y",function(d) {return y(d3.max([d[2]+d[1],0]));})
			.attr("height",function(d) {return y2(Math.abs(d[1]));})

		columns.selectAll("rect")
			.on("mouseover",function() {d3.select(this).classed("highlighted",1);})
			.on("mouseout",function()  {d3.select(this).classed("highlighted",0);});
		if ($) {$('a').tipsy({html: true, gravity: 's'});}


		writeHLabels(attr);
		drawGridlines(attr);
		writeVLabels(attr);
		writeTitle(attr);
		writeLegends(attr);
		writeSource(attr);
	}
}

function clusteredChart(attr)
{
// version 2.0
// this is the code for a horizontal, clustered bar chart.

	if (attr["data"]&&attr["div"]) { // that we really need. the rest, we can manage
		attr["stacked"]=false;
		attr=complete(attr);

		var data=attr["data"];
		var div=attr["div"];
		var height=attr["height"];
		var width=attr["width"];
		var min=attr["min"];
		var max=attr["max"];
		var axis=attr["axis"];
		var ticks=attr["ticks"];
		var lAngle=attr["lAngle"];

		var margin=attr["margin"];
		var axis=attr["axis"];
		var header=attr["header"];
		var footer=attr["footer"];

		var nbSeries=attr["nbSeries"];

		var chartAreaWidth=width-margin-axis; 
		var chartAreaHeight=height-footer-header; 

		// end of temp variables

		var x=d3.scale.ordinal()
		  .domain(d3.range(data.length))
		  .rangeBands([0,chartAreaWidth],.1);
		var y,y2;
		y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
		y2=d3.scale.linear().domain([0,max-min]).range([0,chartAreaHeight]);
		d3.select(div).selectAll("svg").remove();
		var svg=d3.select(div).append("svg:svg");
		svg.attr("width",width).attr("height",height)
		svg.append("svg:rect").attr("width",width).attr("height",height).style("fill","white");
		var chart=svg.append("svg:g");
		var chartarea=svg.append("svg:g").attr("transform","translate("+axis+","+header+")").classed("chartarea",1);
		chartarea.append("svg:rect").attr("width",chartAreaWidth).attr("height",chartAreaHeight).style("fill","white");
		var columns=chartarea
			.selectAll(".column")
			.data(data)
			.enter()
			.append("svg:g")
			.attr("class","column");

		columns.attr("transform", function(d,i) {return "translate("+x(i)+",0)";})
		columns.selectAll("a").data(
				function(d) {
					return d.values.map(function(v,i) {return [d.category,parseFloat(v),d3.sum(d.values.slice(0,i)),((attr["sColor"]+i)%10)];})}
			).enter()
			.append("svg:a").attr("title",function(d) {return d[0]+": "+d[1];})
			.append("svg:rect")
				.attr("class",function(d) {return "clusteredRect v"+d[3];})
				.attr("y",y(0))
				.attr("height",0)
				.attr("x",function(d,i) {return i*x.rangeBand()/nbSeries;})
				.attr("width",function() {return x.rangeBand()/nbSeries;});
		columns.selectAll(".clusteredRect").transition()
			.delay(100).duration(1000)
			.attr("y",function(d) {return y(d3.max([d[1],0]));})
			.attr("height",function(d) {return y2(Math.abs(d[1]));})

		columns.selectAll("rect")
			.on("mouseover",function() {d3.select(this).classed("highlighted",1);})
			.on("mouseout",function()  {d3.select(this).classed("highlighted",0);});
		if ($) {$('a').tipsy({html: true, gravity: 's'});}


		writeHLabels(attr);
		drawGridlines(attr);
		writeVLabels(attr);
		writeTitle(attr);
		writeLegends(attr);
		writeSource(attr);
	}
}


function lineChart(attr)
{
// version 2.0
// works, but soon to be deprecated
// this is the code for a horizontal, clustered bar chart.

	if (attr["data"]&&attr["div"]) { // that we really need. the rest, we can manage
		attr["stacked"]=false;
		attr=complete(attr);

		var data=attr["data"];
		var div=attr["div"];
		var height=attr["height"];
		var width=attr["width"];
		var min=attr["min"];
		var max=attr["max"];
		var axis=attr["axis"];
		var ticks=attr["ticks"];
		var lAngle=attr["lAngle"];

		var margin=attr["margin"];
		var axis=attr["axis"];
		var header=attr["header"];
		var footer=attr["footer"];

		var nbSeries=attr["nbSeries"];

		var chartAreaWidth=width-margin-axis; 
		var chartAreaHeight=height-footer-header; 

		// end of temp variables
		
		var domain=data.map(function(d) {return d.category;})
		
		var x=d3.scale.ordinal()
		  .domain(domain)
		  .rangePoints([0,chartAreaWidth]);
		var y;
		y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
		
		var line=d3.svg.line().x(function(d) {return x(d[0]);}).y(function(d) {return y(d[1]);});
		
		
		d3.select(div).selectAll("svg").remove();
		var svg=d3.select(div).append("svg:svg");
		svg.attr("width",width).attr("height",height)
		svg.append("svg:rect").attr("width",width).attr("height",height).style("fill","white");
		var chart=svg.append("svg:g");
		var chartarea=svg.append("svg:g").attr("transform","translate("+axis+","+header+")").classed("chartarea",1);
		chartarea.append("svg:rect").attr("width",chartAreaWidth).attr("height",chartAreaHeight).style("fill","white");
		
		
		
		domain.forEach(function(s,i) {
			var lineData=[];
			data.forEach(function(d) {
				if(d.values.length>i) {
					if(d.values[i]!="") {
						lineData.push([d.category, parseFloat(d.values[i])]);
					}
				}
			});
			if (lineData.length>1) {
				chartarea.append("svg:path").attr("class","linechart l"+((attr["sColor"]+i)%10))
				.attr("d",line(lineData));
			}
				
		;})
		
		
		/*columns.selectAll("rect")
			.on("mouseover",function() {d3.select(this).classed("highlighted",1);})
			.on("mouseout",function()  {d3.select(this).classed("highlighted",0);});
		if ($) {$('a').tipsy({html: true, gravity: 's'});}*/


		//writeHTLabels(attr);
		//drawLGridlines(attr);
		writeVLabels(attr);
		writeTitle(attr);
		writeLegends(attr);
		writeSource(attr);
	}
}

function lineChartAnimate(attr)
{
// version 2.5
// this is the code for a horizontal, clustered bar chart.

	if (attr["data"]&&attr["div"]) { // that we really need. the rest, we can manage
		attr["stacked"]=false;
		attr=complete(attr);

		var data=attr["data"];
		var div=attr["div"];
		var height=attr["height"];
		var width=attr["width"];
		var min=attr["min"];
		var max=attr["max"];
		var axis=attr["axis"];
		var ticks=attr["ticks"];
		var lAngle=attr["lAngle"];

		var margin=attr["margin"];
		var axis=attr["axis"];
		var header=attr["header"];
		var footer=attr["footer"];

		var nbSeries=attr["nbSeries"];

		var chartAreaWidth=width-margin-axis; 
		var chartAreaHeight=height-footer-header; 

		// end of temp variables
		
		var domain=data.map(function(d) {return d.category;})
		
		var myData={};
		d3.range(nbSeries).forEach(function(d) {myData(d)=[];})
		data.forEach(function(x) {x.values.forEach(function(d,i) {if(d!=""){myData[i].push([x.category,parseFloat(d)]);}})})
		d3.keys(myData).forEach(function(k) {if (myData[k].length<2) {delete myData[k];}})
		
		

		
		var x=d3.scale.ordinal()
		  .domain(domain)
		  .rangePoints([0,chartAreaWidth]);
		var y;
		y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
		
		var line=d3.svg.line().x(function(d) {return x(d[0]);}).y(function(d) {return y(d[1]);});
		
		
		
		
		d3.select(div).selectAll("svg").remove();
		var svg=d3.select(div).append("svg:svg");
		svg.attr("width",width).attr("height",height)
		svg.append("svg:rect").attr("width",width).attr("height",height).style("fill","white");
		var chart=svg.append("svg:g");
		var chartarea=svg.append("svg:g").attr("transform","translate("+axis+","+header+")").classed("chartarea",1);
		chartarea.append("svg:rect").attr("width",chartAreaWidth).attr("height",chartAreaHeight).style("fill","white");
		
		chartarea.selectAll(".lineChart").data(d3.keys(myData)).enter().append("g").classed("lineChart",1);
		var myLines=chartarea.selectAll(".lineChart")
		
		domain.forEach(function(s,i) {
			var lineData=[];
			data.forEach(function(d) {
				if(d.values.length>i) {
					if(d.values[i]!="") {
						lineData.push([d.category, parseFloat(d.values[i])]);
					}
				}
			});
			if (lineData.length>1) {
				chartarea.append("svg:path").attr("class","linechart l"+((attr["sColor"]+i)%10))
				.attr("d",line(lineData));
			}
				
		;})
		
		
		/*columns.selectAll("rect")
			.on("mouseover",function() {d3.select(this).classed("highlighted",1);})
			.on("mouseout",function()  {d3.select(this).classed("highlighted",0);});
		if ($) {$('a').tipsy({html: true, gravity: 's'});}*/


		//writeHTLabels(attr);
		//drawLGridlines(attr);
		writeVLabels(attr);
		writeTitle(attr);
		writeLegends(attr);
		writeSource(attr);
		
		function draw(k) {
			myLines.each(function(d) {
			var myLine=d3.select(this);
			myLine.select("path").attr("d",function(d) {return line(myData[d].slice(0,k);})
			
			}
		}
	}
}


function writeHLabels(attr) {
	var chartarea=d3.select(attr["div"]).select(".chartarea");
	var chartAreaWidth=attr["width"]-attr["margin"]-attr["axis"];
	var chartAreaHeight=attr["height"]-attr["footer"]-attr["header"]
	var data=attr["data"];
	
	var x=d3.scale.ordinal()
	  .domain(d3.range(data.length))
  	  .rangeBands([0,chartAreaWidth],.1);

	var labels=chartarea
		.selectAll(".label")
		.data(attr["data"])
		.enter()
		.append("svg:g")
		.attr("class","hLabel");
	labels.attr("transform", function(d,i) {return "translate("+x(i)+","+(chartAreaHeight)+")";})
		.append("svg:text")
		.attr("x",-1)
		.attr("dy",".35em")
		.text(function(d) {return d.category;})
		.style("font",attr["fontLabel"])
	if (attr["lAngle"]) {
		labels.selectAll("text").attr("transform","rotate("+(-attr["lAngle"])+","+(x.rangeBand()/2)+",0),translate("+(x.rangeBand()/2)+",5)")
		.attr("text-anchor","end");}
	else {labels.selectAll("text").attr("transform","translate("+(x.rangeBand()/2)+",0)")
		.style("dominant-baseline","hanging")
		.attr("text-anchor","middle");}
}

function drawGridlines(attr) {
	console.log("coucou");
	var chartarea=d3.select(attr["div"]).select(".chartarea");
	var chartAreaWidth=attr["width"]-attr["margin"]-attr["axis"];
	var chartAreaHeight=attr["height"]-attr["footer"]-attr["header"];
	var data=attr["data"];var min=attr["min"];var max=attr["max"];
	var y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
	var gridlines=chartarea
		.selectAll(".gridline")
		.data(y.ticks(attr["vTicks"]))
		.enter()
		.append("svg:line").attr("class","gridline");
	gridlines
		.attr("shape-rendering","crispEdges")
		.attr("x1",0).attr("x2",chartAreaWidth)
		.attr("y1",function(d) {return y(d)+.5;})
		.attr("y2",function(d) {return y(d)+.5;})
}

function writeVLabels(attr) {
	var chartarea=d3.select(attr["div"]).select(".chartarea");
	var chartAreaWidth=attr["width"]-attr["margin"]-attr["axis"];
	var chartAreaHeight=attr["height"]-attr["footer"]-attr["header"];
	var data=attr["data"];var min=attr["min"];var max=attr["max"];
	var y=d3.scale.linear().domain([min,max]).range([chartAreaHeight,0]);
	var ylabels=chartarea
		.selectAll(".ylabel")
		.data(y.ticks(attr["vTicks"]))
		.enter()
		.append("svg:text").attr("class","ylabel").style("font",attr["fontLabel"]);
	ylabels
		.attr("x",-3).attr("dy",".35em").attr("text-anchor","end")
		.attr("transform",function(d) {return "translate(0,"+(y(d)+.5)+")";})
		.text(String)
}

function writeLegends(attr) {
	seriesNames=attr["legends"].slice(1,10);
	var svg=d3.select(attr["div"]).select("svg");
	var nbLines=1;
	var width=attr["width"],height=attr["height"];
	var cursor=10;
	seriesNames.forEach(function(d,i) {
		if((cursor+=20+d.visualFLength(attr["fontUnit"]))>(width-10)){
			nbLines++;cursor=30+d.visualFLength(attr["fontUnit"]);}
		});
	var legends=svg.append("svg:g").attr("transform","translate(10,"+(height-nbLines*20)+")").classed("legends",1);
	cursor=10;var currentLine=0;
	seriesNames.forEach(function(d,i) {
		legends.append("svg:rect")
			.attr("x",cursor)
			.attr("y",3+currentLine*20)
			.attr("width",15)
			.attr("height",11)
			.classed("v"+(i+sColor)%10,1);
		cursor+=20;
		legends.append("svg:text")
			.text(d)
			.attr("x",cursor)
			.attr("y",10+currentLine*20)
			.style("font",attr["fontUnit"]);
		cursor+=d.visualFLength(attr["fontUnit"])+5;
		if(i<(seriesNames.length-1)) {if(cursor+35+seriesNames[i+1].visualFLength(attr["fontUnit"])>width) {cursor=10;currentLine++;}}
	;})
}

function writeTitle(attr) {
	var svg=d3.select(attr["div"]).select("svg");
	svg.selectAll("titleBox").remove();
	line=d3.svg.line().x(function(d) {return d.x*attr["cw"];}).y(function(d) {return d.y*attr["ch"];})

	var titleBox=svg.append("svg:g").classed("titleBox",1).classed("blue",attr["blue"]);
	titleBox
		.append("svg:rect").attr("x",0).attr("y",0).attr("width",attr["width"]).attr("height",attr["hTitle"])
	titleBox.append("svg:text")
		.attr("x",(attr["logo"]?attr["cw"]:0)+5)
		.attr("y",(attr["hTitle"]/2-5))
		.text(attr["title"]).style("font",attr["fontTitle"]);
	titleBox.append("svg:text")
		.attr("x",(attr["logo"]?attr["cw"]:0)+5)
		.attr("y",attr["hTitle"]/2+2)
		.style("dominant-baseline","hanging")
		.text(attr["subtitle"])
		.style("font",attr["fontSubtitle"]);
	if (attr["logo"]) {titleBox.append("svg:path").attr("d",line(chevron)+"Z").attr("transform","translate(1,"+(attr["hTitle"]-attr["ch"])/2+")");
			   titleBox.append("svg:path").attr("d",line(chevron)+"Z").attr("transform","translate("+(1+.5*attr["cw"])+","+(attr["hTitle"]-attr["ch"])/2+")");};
}

function writeSource() {
}


function barchart(attr) 
{
// version 1.1
// this is the code for a horizontal, stacked bar chart. 
// deprecated


if (attr["data"]&&attr["div"]) { // that we really need. the rest, we can manage

var data=attr["data"];
var div=attr["div"];
var height=attr["height"]||400;
var width=attr["width"]||600;
var minValue=attr["min"]||d3.min([0,d3.min(data, function(d) {return d.value0+d.value1+d.value2;})]);
var topValue=attr["max"]||d3.max(data, function(d) {return d.value0+d.value1+d.value2;});
var labelWidth=attr["labelWidth"]||(topValue+'').visualLength("label")+5;
var ticks=attr["ticks"]||5;

//(myMax+'').visualLength(fontLabel)+5;


// all of the following will be sent as parameters or computed in subsequent versions
var chartAreaWidth=551; 
var chartAreaHeight=164; 

var headerHeight=95;
// end of temp variables



var x=d3.scale.ordinal()
  .domain(d3.range(data.length))
  .rangeBands([0,chartAreaWidth],.1);

var y=d3.scale.linear().domain([minValue,topValue]).range([chartAreaHeight,0]);

var svg=d3.select(div).append("svg:svg");
svg.attr("width",width).attr("height",height)
svg.append("svg:rect").attr("width",width).attr("height",height).style("fill","white");
var chart=svg.append("svg:g");
var chartarea=svg.append("svg:g").attr("transform","translate("+labelWidth+","+headerHeight+")");
chartarea.append("svg:rect").attr("width",chartAreaWidth).attr("height",chartAreaHeight).style("fill","#eee");
var columns=chartarea
	.selectAll(".column")
	.data(data)
	.enter()
	.append("svg:g")
	.attr("class","column");

columns.attr("transform", function(d,i) {return "translate("+x(i)+",0)";})
columns
	.append("svg:a").attr("title",function(d) {return d.category+": "+d.value0;})
	.append("svg:rect")
		.attr("class","v0")
		.attr("y",y(0))
		.attr("height",0) 
		.attr("width",function() {return x.rangeBand();});
columns
	.append("svg:a").attr("title",function(d) {return d.category+": "+d.value1;})
	.append("svg:rect")
		.attr("class","v1")
		.attr("y",y(0))
		.attr("height",0) 
		
		.attr("width",function() {return x.rangeBand();});
columns
	.append("svg:a").attr("title",function(d) {return d.category+": "+d.value2;})
	.append("svg:rect")
		.attr("class","v2")
		.attr("y",y(0))
		.attr("height",0) 
		.attr("width",function() {return x.rangeBand();});

columns.selectAll(".v0").transition().delay(100).duration(1000).attr("y",function(d) {return y(d.value0);}).attr("height",function(d) {return y(0)-y(d.value0);});
columns.selectAll(".v1").transition().delay(100).duration(1000).attr("y",function(d) {return y(d.value0+d.value1);}).attr("height",function(d) {return y(0)-y(d.value1);});
columns.selectAll(".v2").transition().delay(100).duration(1000).attr("y",function(d) {return y(d.value0+d.value1+d.value2);}).attr("height",function(d) {return y(0)-y(d.value2);});

columns.selectAll("rect")
	.on("mouseover",function() {d3.select(this).classed("highlighted",1);})
	.on("mouseout",function()  {d3.select(this).classed("highlighted",0);});
 $('a').tipsy({html: true, gravity: 's'}); 



var labels=chartarea
	.selectAll(".label")
	.data(data)
	.enter()
	.append("svg:g")
	.attr("class","label");
labels.attr("transform", function(d,i) {return "translate("+x(i)+","+chartAreaHeight+")";})
	.append("svg:text")
	.attr("x",-1)
	.attr("dy",".35em")
	.attr("transform","rotate(-90,"+(x.rangeBand()/2)+",0)")
	.attr("text-anchor","end")
	.text(function(d) {return d.category;})

var gridlines=chartarea
	.selectAll(".gridline")
	.data(y.ticks(5))
	.enter()
	.append("svg:line").attr("class","gridline");
gridlines
	.attr("shape-rendering","crispEdges")
	.attr("x1",0).attr("x2",chartAreaWidth)
	.attr("y1",function(d) {return y(d)+.5;})
	.attr("y2",function(d) {return y(d)+.5;})
var ylabels=chartarea
	.selectAll(".ylabel")
	.data(y.ticks(5))
	.enter()
	.append("svg:text").attr("class","ylabel");
ylabels
	.attr("x",-3).attr("dy",".35em").attr("text-anchor","end")
	.attr("transform",function(d) {return "translate(0,"+(y(d)+.5)+")";})
	.text(String)


}
}

function makeSlideShow(div){
	var slideShow=d3.select(div);
	var slides=slideShow.selectAll(".slide");
	var nbSlides=slides[0].length;
	var buttons=slideShow.append("ul").attr("class","buttons");
	var current=1;
	buttons.selectAll("li").data(d3.range(nbSlides)).enter().append("li")
		.html(function(d) {return d+1;})
		.on("click", function(d) {isCurrent(d+1);});
	buttons.append("li").attr("class","next")
		.html("NEXT")
		.on(
			"click", 
			function(d) {
				isCurrent(
					Math.min(nbSlides,current+1)
				);
			}
		);
	
	
	slideShow.selectAll(".slide").filter(function(d,i) {return i==current-1;}).classed("current",1);

	
	function isCurrent(slideID) {
		eval(slideShow.selectAll(".current").attr("exit"));
		slideShow.selectAll(".current").classed("current",0);
		slideShow.selectAll(".slide").filter(function(d,i) {return (i+1)==slideID;}).classed("current",1);
		eval(slideShow.selectAll(".current").attr("entry"));
	}
	

}

function test()
{d3.selectAll(".span7").selectAll("#chart2").remove();
 d3.selectAll(".span7").append("div").attr("id","chart2");
 attr["div"]="#chart2"
 //stackedChart(attr);
 //clusteredChart(attr);
 lineChart(attr);
 }