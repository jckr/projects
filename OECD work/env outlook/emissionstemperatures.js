var data=[
{year:1970, scenarios:[{key:"baseline",values:[{key:"emissions",value:26},{key:"concentration",value:326.539}, {key:"temperature",value:0.261718}]},{key:"450 core",values:[{key:"emissions",value:26},{key:"concentration",value:326.539}, {key:"temperature",value:0.261718}]}]},
{year:1975, scenarios:[{key:"baseline",values:[{key:"emissions",value:28},{key:"concentration",value:333.957}, {key:"temperature",value:0.279299}]},{key:"450 core",values:[{key:"emissions",value:28},{key:"concentration",value:333.957}, {key:"temperature",value:0.279299}]}]},
{year:1980, scenarios:[{key:"baseline",values:[{key:"emissions",value:31.5},{key:"concentration",value:342.591}, {key:"temperature",value:0.35816}]},{key:"450 core",values:[{key:"emissions",value:31.5},{key:"concentration",value:342.591}, {key:"temperature",value:0.35816}]}]},
{year:1985, scenarios:[{key:"baseline",values:[{key:"emissions",value:31},{key:"concentration",value:350.797}, {key:"temperature",value:0.458521}]},{key:"450 core",values:[{key:"emissions",value:31},{key:"concentration",value:350.797}, {key:"temperature",value:0.458521}]}]},
{year:1990, scenarios:[{key:"baseline",values:[{key:"emissions",value:33},{key:"concentration",value:359.38}, {key:"temperature",value:0.553264}]},{key:"450 core",values:[{key:"emissions",value:33},{key:"concentration",value:359.38}, {key:"temperature",value:0.553264}]}]},
{year:1995, scenarios:[{key:"baseline",values:[{key:"emissions",value:35.5},{key:"concentration",value:367.69}, {key:"temperature",value:0.659111}]},{key:"450 core",values:[{key:"emissions",value:35.5},{key:"concentration",value:367.69}, {key:"temperature",value:0.659111}]}]},
{year:2000, scenarios:[{key:"baseline",values:[{key:"emissions",value:39},{key:"concentration",value:375.773}, {key:"temperature",value:0.756579}]},{key:"450 core",values:[{key:"emissions",value:39},{key:"concentration",value:375.773}, {key:"temperature",value:0.756579}]}]},
{year:2005, scenarios:[{key:"baseline",values:[{key:"emissions",value:44},{key:"concentration",value:387.041}, {key:"temperature",value:0.865331}]},{key:"450 core",values:[{key:"emissions",value:44},{key:"concentration",value:387.041}, {key:"temperature",value:0.865038}]}]},
{year:2010, scenarios:[{key:"baseline",values:[{key:"emissions",value:48.40939275177},{key:"concentration",value:400.303}, {key:"temperature",value:1.00012}]},{key:"450 core",values:[{key:"emissions",value:48.33485544857},{key:"concentration",value:385.83929}, {key:"temperature",value:0.999001}]}]},
{year:2015, scenarios:[{key:"baseline",values:[{key:"emissions",value:51.741174447934},{key:"concentration",value:414.292}, {key:"temperature",value:1.14271}]},{key:"450 core",values:[{key:"emissions",value:49.677334940499},{key:"concentration",value:401.62703}, {key:"temperature",value:1.13164}]}]},
{year:2020, scenarios:[{key:"baseline",values:[{key:"emissions",value:55.161591174299},{key:"concentration",value:430.748}, {key:"temperature",value:1.30948}]},{key:"450 core",values:[{key:"emissions",value:48.830698657821},{key:"concentration",value:420.98518}, {key:"temperature",value:1.26598}]}]},
{year:2025, scenarios:[{key:"baseline",values:[{key:"emissions",value:58.807066366128},{key:"concentration",value:446.911}, {key:"temperature",value:1.47686}]},{key:"450 core",values:[{key:"emissions",value:46.973367617876},{key:"concentration",value:438.08975}, {key:"temperature",value:1.38369}]}]},
{year:2030, scenarios:[{key:"baseline",values:[{key:"emissions",value:62.491686132535},{key:"concentration",value:463.689}, {key:"temperature",value:1.64711}]},{key:"450 core",values:[{key:"emissions",value:43.108345400732},{key:"concentration",value:454.73069}, {key:"temperature",value:1.48402}]}]},
{year:2035, scenarios:[{key:"baseline",values:[{key:"emissions",value:66.538327493106},{key:"concentration",value:481.48}, {key:"temperature",value:1.82023}]},{key:"450 core",values:[{key:"emissions",value:38.173883579585},{key:"concentration",value:464.2903}, {key:"temperature",value:1.57228}]}]},
{year:2040, scenarios:[{key:"baseline",values:[{key:"emissions",value:70.97366928494},{key:"concentration",value:499.902}, {key:"temperature",value:1.99292}]},{key:"450 core",values:[{key:"emissions",value:33.301561159382},{key:"concentration",value:470.61612}, {key:"temperature",value:1.64557}]}]},
{year:2045, scenarios:[{key:"baseline",values:[{key:"emissions",value:75.68812402846},{key:"concentration",value:519.065}, {key:"temperature",value:2.16781}]},{key:"450 core",values:[{key:"emissions",value:28.791081142824},{key:"concentration",value:474.54253}, {key:"temperature",value:1.69706}]}]},
{year:2050, scenarios:[{key:"baseline",values:[{key:"emissions",value:80.837049756724},{key:"concentration",value:538.866}, {key:"temperature",value:2.34488}]},{key:"450 core",values:[{key:"emissions",value:24.611876157295},{key:"concentration",value:475.21959}, {key:"temperature",value:1.73218}]}]},
{year:2055, scenarios:[{key:"baseline",values:[{key:"emissions",value:85.5747946076597},{key:"concentration",value:559.94}, {key:"temperature",value:2.52519}]},{key:"450 core",values:[{key:"emissions",value:20.280846268946},{key:"concentration",value:474.32269}, {key:"temperature",value:1.75215}]}]},
{year:2060, scenarios:[{key:"baseline",values:[{key:"emissions",value:91.0532957649555},{key:"concentration",value:582.777}, {key:"temperature",value:2.71057}]},{key:"450 core",values:[{key:"emissions",value:16.5274635427132},{key:"concentration",value:473.00627}, {key:"temperature",value:1.76513}]}]},
{year:2065, scenarios:[{key:"baseline",values:[{key:"emissions",value:96.0314505905623},{key:"concentration",value:607.162}, {key:"temperature",value:2.90172}]},{key:"450 core",values:[{key:"emissions",value:12.8543215863787},{key:"concentration",value:471.54223}, {key:"temperature",value:1.76659}]}]},
{year:2070, scenarios:[{key:"baseline",values:[{key:"emissions",value:101.436781937197},{key:"concentration",value:633.236}, {key:"temperature",value:3.10023}]},{key:"450 core",values:[{key:"emissions",value:9.97522504712078},{key:"concentration",value:469.40426}, {key:"temperature",value:1.75526}]}]},
{year:2075, scenarios:[{key:"baseline",values:[{key:"emissions",value:105.649193700242},{key:"concentration",value:660.876}, {key:"temperature",value:3.30601}]},{key:"450 core",values:[{key:"emissions",value:7.25923409009186},{key:"concentration",value:466.93256}, {key:"temperature",value:1.73497}]}]},
{year:2080, scenarios:[{key:"baseline",values:[{key:"emissions",value:108.778578434473},{key:"concentration",value:689.357}, {key:"temperature",value:3.51518}]},{key:"450 core",values:[{key:"emissions",value:4.51821228737679},{key:"concentration",value:463.49662}, {key:"temperature",value:1.7078}]}]},
{year:2085, scenarios:[{key:"baseline",values:[{key:"emissions",value:111.81435116547},{key:"concentration",value:718.776}, {key:"temperature",value:3.72508}]},{key:"450 core",values:[{key:"emissions",value:3.05183220883599},{key:"concentration",value:458.7055}, {key:"temperature",value:1.67475}]}]},
{year:2090, scenarios:[{key:"baseline",values:[{key:"emissions",value:114.700814344407},{key:"concentration",value:749}, {key:"temperature",value:3.93363}]},{key:"450 core",values:[{key:"emissions",value:2.28149228866265},{key:"concentration",value:453.73202}, {key:"temperature",value:1.63732}]}]},
{year:2095, scenarios:[{key:"baseline",values:[{key:"emissions",value:117.689041261102},{key:"concentration",value:780.413}, {key:"temperature",value:4.14183}]},{key:"450 core",values:[{key:"emissions",value:2.14079910969053},{key:"concentration",value:449.24802}, {key:"temperature",value:1.59552}]}]},
{year:2100, scenarios:[{key:"baseline",values:[{key:"emissions",value:119.769054102373},{key:"concentration",value:812.558}, {key:"temperature",value:4.34853}]},{key:"450 core",values:[{key:"emissions",value:1.28906902999096},{key:"concentration",value:444.94046}, {key:"temperature",value:1.55428}]}]}];
var w=800,h=400;
var scales=[
	{key:"emissions",domain:[0,120]},
	{key:"concentration",domain:[300,900]},
	{key:"temparature",domain:[0,5]}];

var labels=[
	{key:"emissions",title:"Greenhouse gas emissions",subtitle:"Billion tonnes of CO2 equivalent"},
	{key:"concentration",title:"CO2 concentration",subtitle:"Parts per million"},
	{key:"temperature",title:"Temperature increases",subtitle:"Celsius degrees"}]
	

var currentView=0;
var currentScenario=0;

var svg=d3.select("#chart").append("svg:svg").attr("width",w).attr("height",h);

var x=d3.scale.linear().domain([1970,2100]).range([50,w-15]);
var y=d3.scale.linear().domain(scales[0].domain).range([h-20,50]);
var d=d3.scale.linear().domain([0,5]).range([0,50]);

// prepare data
var mySeries=[];
data.forEach(function(d) {mySeries.push({year:d.year,value:d.scenarios[0].values[0].value});})


var duration=250,ease="linear";

var myG=svg.append("svg:g").classed("series",1);

/*myG.on("mouseover",function() {
	svg.selectAll(".series").filter(function() {return d3.select(this).attr("id")!="g"+i;})
	.style("opacity",.2);})

myG.on("mouseout",function() {svg.selectAll("g").style("opacity",1);})*/


myG.append("svg:g").classed("lines",1);
var circles=myG.append("svg:g").classed("circles",1);
var circle=circles.append("svg:circle")
	.attr("cx",x(mySeries[0].year)) // probably on the y axis, but hey
	.attr("cy",y(mySeries[0].value))
	.style("stroke","black").style("stroke-width",3).style("fill","white")
	.attr("r",0)
	.attr("class","circle c0");
circle.append("svg:title").text(function(d) {return mySeries[0].value.toFixed(1);})
circle.transition().duration(250).attr("r",5);
drawSegment(mySeries,0);

svg.append("svg:text").classed("h1",1).text(labels[currentView].title).attr("x",80).attr("y",80).style("font-size","24px").style("font-weight","bold");
svg.append("svg:text").classed("h2",1).text(labels[currentView].subtitle).attr("x",80).attr("y",110).style("font-size","18px");

var xAxis = d3.svg.axis()
    .scale(x)
    .ticks(5)
    .tickSize(6, 3, 0)
    .tickFormat(d3.format(""));
    
var yAxis = d3.svg.axis()
    .scale(y)
    .ticks(5)
    .orient("left")
    .tickSize(6, 3, 0)
    .tickFormat(d3.format(""));

var myxAxis=svg.append("svg:g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + (h-20)+ ")")
      .call(xAxis);

var myyAxis=svg.append("svg:g")
      .attr("class", "y axis")
      .attr("transform", "translate(50,0)")
      .call(yAxis);
//svg.append("svg:text").attr("transform","rotate(-90) translate(-100,20)").text(data.yAxisLabel).attr("x",20).attr("y",0);

d3.selectAll(".axis").selectAll("path, line").style("stroke","black");
		



var pages=d3.select("#pages");
var tabs=["Emissions","Concentration","Temperature"];
var li=pages.append("ul").selectAll("li").data(["prev",tabs[0],tabs[1],tabs[2],"next"]).enter().append("li");
li.append("a").attr("href","#").html(function(d) {
	if (d=="prev") {return "&larr; Previous";};
	if (d=="next") {return "Next &rarr;";};
	return d;})
li.filter(function(d) {return d=="prev";}).classed("prev",1).classed("disabled",1);
li.filter(function(d) {return d=="next";}).classed("next",1);
li.filter(function(d) {return d=="Emissions";}).classed("active",1);

li.on("click", function(d,i) {
	if (d3.select(this).classed("disabled")==0) {
		if(d=="prev"&&currentView>0) {
			currentView--;	
			
		} else if (d=="next"&&currentView<5) {
			currentView++;
		} else {
			currentView=i-1;
		}
		li.filter(function(d) {return d=="prev";}).classed("disabled",(currentView==0));
		li.filter(function(d) {return d=="next";}).classed("disabled",(currentView==2));
	
		li.classed("active",0);
		li.filter(function(d) {return d==tabs[currentView];}).classed("active",1);
		transitionTo(currentView,currentScenario);
	}
})

var button=d3.select("button")
var scenarios=["baseline","alternative"];

button.html("Switch to "+scenarios[1-currentScenario]+" scenario");
button.on("click",function() {
	currentScenario=1-currentScenario;
	button.html("Switch to "+scenarios[1-currentScenario]+" scenario");
	transitionTo(currentView,currentScenario);
})


function drawSegment(mySeries,s) {
	if(s>=mySeries.length-1) {$('circle').tipsy({html: true, gravity: 's'});return;} // when the last segment is reached, drop it
	else {
		var myG=svg.select("g.series");
		var lines=myG.select(".lines");var circles=myG.select(".circles");
		lines.append("svg:line")
			.attr("x1",x(mySeries[s].year))
			.attr("x2",x(mySeries[s].year))
			.attr("y1",y(mySeries[s].value))
			.attr("y2",y(mySeries[s].value))
			.style("stroke","black")
			.style("stroke-width",3)
			.transition().ease("linear")
			.duration(d(mySeries[s+1].year-mySeries[s].year))
			.attr("x2",x(mySeries[s+1].year))
			.attr("y2",y(mySeries[s+1].value))
			.each("end",function() {
				var circle=circles.append("svg:circle")
					.attr("cx",x(mySeries[s+1].year))
					.attr("cy",y(mySeries[s+1].value))
					.style("stroke","black").style("stroke-width",3).style("fill","white")
					.attr("r",0)
					.attr("class","circle c"+s);
				circle.append("svg:title").text(function(d) {return mySeries[s+1].year+": "+mySeries[s+1].value.toFixed(1);})
				circle.transition().duration(500).attr("r",5);
				drawSegment(mySeries,s+1);	// after transition, we try to draw the next segment
			;})
	}
}



function transitionTo(view,scenario) {
	var myG=svg.select("g.series")
	var lines=myG.select(".lines");var circles=myG.select(".circles");
	
	y.domain(scales[view].domain);
	yAxis = d3.svg.axis()
	    .scale(y)
	    .ticks(5)
	    .orient("left")
	    .tickSize(6, 3, 0)
    	    .tickFormat(d3.format(""));
    	
    	var myyAxis=svg.select("g.y.axis")	      
      	      .call(yAxis);
      	      
      	d3.selectAll(".axis").selectAll("path, line").style("stroke","black");
      
      	svg.select(".h1").text(labels[currentView].title).attr("x",80).attr("y",80).style("font-size","24px").style("font-weight","bold");
	svg.select(".h2").text(labels[currentView].subtitle).attr("x",80).attr("y",110).style("font-size","18px");
	
	mySeries=[];
	data.forEach(function(d) {mySeries.push({year:d.year,value:d.scenarios[scenario].values[view].value});})
	
	lines.selectAll("line").transition()
		.attr("x1",function(d,i) {return x(mySeries[i].year);})
		.attr("x2",function(d,i) {return x(mySeries[i+1].year);})
		.attr("y1",function(d,i) {return y(mySeries[i].value);})
		.attr("y2",function(d,i) {return y(mySeries[i+1].value);})
	circles.selectAll("title").remove();circles.selectAll("original-title").remove();
	circles.selectAll("circle").transition()
		.attr("cx",function(d,i) {return x(mySeries[i].year);})
		.attr("cy",function(d,i) {return y(mySeries[i].value);})
		.attr("r",5) // (in case sb clicks before the line is all grown)
	
	circles.selectAll("circle").append("svg:title").text(function(d,i) {return mySeries[i].year+": "+mySeries[i].value.toFixed(1);});
	
	$('circle').tipsy({html: true, gravity: 's'});

}