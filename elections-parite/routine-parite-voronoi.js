
//var borders=[
//[[8.7459898,42.62812042],[9.39000034,43.00999832],[9.56000042,42.15250015],[9.22976971,41.38000107],[8.77573967,41.58361053],[8.54421997,42.25651932],[8.7459898,42.62812042],[8.7459898,42.62812042]],
//[[6.18628979,49.46382904],[6.65822983,49.20193863],[8.09928036,49.0177803],[7.59368992,48.33301163],[7.46677017,47.62057877],[7.19222021,47.44974899],[6.7365799,47.54182053],[6.76873016,47.28770065],[6.03739023,46.72576141],[6.02258015,46.27297974],[6.50008011,46.42966843],[6.8435998,45.99113846],[6.80234003,45.70861053],[7.09666014,45.33309174],[6.74996996,45.02854919],[7.00756979,44.25476074],[7.5495801,44.12791061],[7.4351902,43.69385147],[6.52924013,43.12891006],[4.55699015,43.39965057],[3.10038996,43.0751915],[2.98598003,42.47299957],[1.82676995,42.34337997],[0.70159,42.79571915],[0.33805001,42.5795517],[-1.50277996,43.03401184],[-1.90135002,43.42279816],[-1.38419831,44.02260971],[-1.19379997,46.01491165],[-2.22572803,47.06438065],[-2.96326661,47.57033157],[-4.49154329,47.95495987],[-4.59232426,48.68416977],[-3.2958076,48.90169144],[-1.61649978,48.6444397],[-1.93347859,49.77632904],[-0.98945999,49.34737015],[1.33876002,50.12717819],[1.63898003,50.9466095],[2.51360011,51.14850998],[2.65841007,50.79682159],[3.12326002,50.78036118],[3.58818007,50.37897873],[4.28602982,49.90752029],[4.79920006,49.98538971],[5.67404985,49.52947998],[5.89773989,49.44268036],[6.18628979,49.46382904],[6.18628979,49.46382904]]];

var borders=
[
[[2.504883,51.124213],[2.702637,50.819818],[3.14209,50.778155],[3.317871,50.513427],[3.625488,50.499452],[3.691406,50.303376],[4.130859,50.34546],[4.108887,49.993615],[4.614258,49.979488],[4.790039,50.176898],[4.943848,50.148746],[4.833984,49.781264],[5.459595,49.518473],[6.541748,49.436382],[6.766968,49.210819],[8.189697,48.962588],[7.590942,47.599167],[6.464844,46.973173],[6.431885,46.766624],[6.036377,46.161233],[6.794434,46.407985],[7.03064,45.940115],[6.816406,45.813912],[6.964722,45.633673],[7.184448,45.406592],[7.124023,45.240515],[6.854858,45.135986],[6.635132,45.120484],[6.755981,44.914682],[7.01416,44.825141],[7.074585,44.66518],[6.882324,44.532194],[6.90979,44.351787],[7.025146,44.23383],[7.365723,44.11958],[7.662353,44.166882],[7.536011,43.811188],[6.640625,43.177586],[5.844116,43.065321],[3.894043,43.50518],[3.119507,43.10945],[3.166504,42.441926],[2.010498,42.36125],[1.934967,42.454874],[1.728973,42.500959],[1.73584,42.615265],[1.479034,42.652647],[0.686646,42.85986],[0.653687,42.710696],[-0.571289,42.79137],[-1.444702,43.080925],[-1.384277,43.273206],[-1.779785,43.377105],[-1.571045,43.508721],[-1.159058,45.502497],[-1.060181,45.56791],[-1.060181,45.506347],[-0.807495,45.356005],[-0.670166,45.092914],[-0.829468,45.506347],[-1.241455,45.698507],[-1.41037,46.045595],[-1.248322,45.994099],[-1.120605,45.857499],[-1.160431,46.154151],[-1.503754,46.194092],[-1.560059,46.253948],[-1.315613,46.208349],[-1.134338,46.255847],[-1.472168,46.339343],[-1.845703,46.513516],[-2.131348,46.920255],[-2.043457,47.219568],[-2.48291,47.279229],[-2.532349,47.52091],[-3.147583,47.565407],[-3.872681,47.809465],[-3.966064,47.894248],[-4.042969,47.850031],[-4.317627,47.783635],[-4.746094,48.052382],[-4.312134,48.103763],[-4.345093,48.224673],[-4.586792,48.242967],[-4.290161,48.305121],[-4.784546,48.330691],[-4.718628,48.600225],[-3.114624,48.871941],[-2.730103,48.534795],[-2.318115,48.694586],[-2.202759,48.618385],[-1.862183,48.701838],[-1.862183,48.622016],[-1.439209,48.654686],[-1.609497,48.75981],[-1.642456,49.235534],[-1.955566,49.724479],[-1.576538,49.660517],[-1.323853,49.703168],[-1.224976,49.617828],[-1.142578,49.396675],[-0.115356,49.292889],[0.296631,49.432413],[0.054932,49.496675],[0.170288,49.717376],[0.55481,49.869857],[1.098633,49.933544],[1.395264,50.078295],[1.587524,50.868378],[2.543335,51.086273]],
[[9.442749,43.012681],
[9.51,42.569264],
[9.52,42.073762],
[9.40979,41.963575],
[9.349365,41.599013],
[9.277954,41.529142],
[9.223022,41.364442],
[9.08844,41.376809],
[9.069214,41.46537],
[8.841248,41.51886],
[8.786316,41.557922],
[8.77533,41.631867],
[8.907166,41.689322],
[8.651733,41.744677],
[8.802795,41.896144],
[8.599548,41.896144],
[8.602295,41.981953],
[8.714905,42.041134],
[8.563843,42.143042],
[8.555603,42.248852],
[8.690186,42.277309],
[8.55011,42.372749],
[8.712158,42.577355],
[9.124146,42.736926],
[9.286194,42.684454],
[9.338379,43.006656]]];

var point=[-4.658203,46.316584];
var stepx=.5;stepy=-.3;
var color = d3.scale.linear()
	.domain([0,.01,.5,.99, 1])//d3.max(data)])
	//.range(["#eee","#ECFAFE", "#066E88"]); 
	.range(["darkblue","blue","silver", "hotpink","deeppink"]); 
var width=800,height=600;
var root = d3.select("#chart").append("svg")
	.attr("width", width)
	.attr("height", height);
	
var defs=root.append("defs");
svg=root.append("g");

//svg.append("rect").attr("x",-50).attr("y",-50).attr("width",1060).attr("height",500).style("fill","#C5F1FC");


var myB;

var project = d3.geo.mercator()
	
	.scale(14172)
	.translate([226, 2348])
	

var t=project.translate();
var s=project.scale();

var noClip;

var
 idToNode = {},
 links = [],
 nodes=[],
 nodesc=[],
 positions=[];
d3.csv("pariteFM.csv",function(csv){

	var clip=borders.map(function(b) {
		var myClip=[];
		b.forEach(function(p) {myClip.push(project(p));})
		return "M"+myClip.join("L")+"Z";
	})

	defs.append("clipPath").attr("id","France")
		.selectAll("path").data(clip).enter().append("path")
		.attr("d",String);

	svg.style("clip-path", "url(#France)").call(d3.behavior.zoom().on("zoom", rescale));

	console.log(csv.length);
	var index=0;
	csv.forEach(function(c,i) {
		
		if(+c.FM){
			c.lon=+c.lon-.05+.1*Math.random();
			c.lat=+c.lat-.05+.1*Math.random();
			var xy=project([c.lon,c.lat]);
			
			idToNode[c.cir]={
				x:xy[0],
				y:xy[1],
				lon:+c.lon,
				lat:+c.lat,
				gravity:{x:xy[0],y:xy[1]},
				r: 8,
				value:c.chance,
				name:c.cir,
				type:c.FM,
				id:i,
				label:c.nom
			};
			nodes.push(idToNode[c.cir]);
			positions.push([idToNode[c.cir].x,idToNode[c.cir].y]);
		} else {
			console.log(index);
			var myPoint=[point[0]+(index%5)*stepx,point[1]+Math.floor(index/5)*stepy];console.log(myPoint);
			xy=project(myPoint);
			idToNode[c.cir]={
				x:xy[0],
				y:xy[1],
				lon:myPoint[0],
				lat:myPoint[1],
				gravity:{x:xy[0],y:xy[1]},
				r: 8,
				value:c.chance,
				name:c.cir,
				id:i,
				type:c.FM,
				label:c.nom
			};
			nodesc.push(idToNode[c.cir]);
			index+=1;
		}
	})

	
	var polygons = d3.geom.voronoi(positions);

	var g = svg.selectAll("g").data(nodes).enter()
		.append("svg:g")
		.attr("class",function(d) {return "C"+d.cir;}); 

	g
		.append("svg:path")
		.attr("class", "cell")
		.attr("id",function(d) {return "b"+d.cir;})
		.style("fill",function(d) {return color(d.value);})
		.style("stroke",function(d) {return d3.rgb(color(d.value)).darker();})
		.style("stroke-width",1)
		//.style("opacity",.8)
		.attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
		.on("mouseover",function(d) {d3.select(this).style("stroke","yellow").style("stroke-width",2);tooltip(d);})
		.on("mouseout",function() {d3.select(this).style("stroke","none").style("stroke-width",1);tooltip(false);})

	root.selectAll("circles").data(nodesc).enter()
		.append("circle")
		.attr("cx",function(d) {return d.x;})
		.attr("cy",function(d) {return d.y;})
		.attr("r",function(d) {return d.r;})
		.style("fill",function(d) {return color(d.value);})
		.on("mouseover",function(d) {d3.select(this).style("stroke","yellow").style("stroke-width",2);tooltip(d);})
		.on("mouseout",function() {d3.select(this).style("stroke","none").style("stroke-width",1);tooltip(false);})


	/*g
		.append("circle")
		.attr("cx",function(d) {return d.x;})
		.attr("cy",function(d) {return d.y;})
		.attr("r",2)
		.style("fill",function(d) {return d3.rgb(color(d.value)).darker();})
		.style("stroke","none")
		//	.style("stroke","black").style("opacity",.5);*/
	myB=svg.selectAll(".borders").data(clip).enter().append("path").attr("d",String).style("fill","none").style("stroke","black").classed("borders",1);

	function rescale() {
      // d3.event.translate (an array) stores the current translation from the parent SVG element
      // t (an array) stores the projection's default translation
      // we add the x and y vales in each array to determine the projection's new translation
      

      var tx = t[0] * d3.event.scale + d3.event.translate[0];
      var ty = t[1] * d3.event.scale + d3.event.translate[1];
      project.translate([tx, ty]);
      project.scale(s*d3.event.scale);
      redraw();

     }
     function redraw(){
     	noClip=false;
		clip=borders.map(function(b) {
			var myClip=[];
			b.forEach(function(p) {
				var proj=project(p);
				
				// if all the points of the clipping mask are going to be outside of screen, then don't bother clipping, it would produce artefacts.

				if(!noClip) {
					if(proj[0]>0 && proj[0]<width && proj[1] > 0 && proj[1] < height) {noClip=false;}
				}
				myClip.push(project(p));})
			return "M"+myClip.join("L")+"Z";
		})

		if (noClip) {clip=["M0,0h"+width+"v"+height+"h"+(-width)+"Z","M0,0Z"];}
		defs.selectAll("path").data(clip).attr("d",String); // that updates clipping mask
		

		nodes.forEach(function(n,i) {
			positions[i]=project([n.lon,n.lat]);
			n.x=positions[i][0];
			n.y=positions[i][1];
		})
		nodesc.forEach(function(n) {
			var proj=project([n.lon,n.lat]);
			n.x=proj[0];
			n.y=proj[1];	
		})
		polygons = d3.geom.voronoi(positions);
		svg.selectAll("g").data(nodes);
		g.selectAll("path").attr("d", function(d) { return "M" + polygons[d.id].join("L") + "Z"; });
		root.selectAll("circle").attr("cx",function(d){return d.x;}).attr("cy",function(d){return d.y;})
		//g.selectAll("circle").attr("cx",function(d) {return d.x;}).attr("cy",function(d) {return d.y;});
		d3.selectAll(".borders").data(clip).attr("d",String);
      
      
    }
    function tooltip(d) {
    	console.log(d);
    	if(d) {d3.select("#tooltip").html("<h3>Chances d'avoir une femme députée :</h3><p><span class='label' style='background-color:white;color:black'>"+d.label+": </span><span class='label' style='background:"+color(d.value)+"'>"+d3.format("%")(d.value))+"</span></p>";}

    }
})

